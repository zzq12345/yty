name: 解析 YouTube 直播 M3U8 地址

on:
  schedule:
    # 每小时运行一次（可根据需要调整频率）
    - cron: '0 * * * *'
  workflow_dispatch:  # 支持手动触发

jobs:
  get_m3u8:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 yt-dlp
        run: |
          python -m pip install --upgrade pip
          pip install yt-dlp

      - name: 获取直播流 M3U8 地址
        id: extract
        run: |
          # 使用 yt-dlp 提取直播流的 URL（通常为 m3u8）
          # --live-from-start 确保处理直播流
          # --skip-download 只获取信息，不下载视频
          # --get-url 输出直接可播放的 URL
          STREAM_URL=$(yt-dlp --live-from-start --skip-download --get-url "https://youtube.com/live/2mCSYvcfhtc" 2>/dev/null | head -n 1)
          echo "Stream URL: $STREAM_URL"
          echo "STREAM_URL=$STREAM_URL" >> $GITHUB_ENV
          echo "$STREAM_URL" > live_stream_url.txt

      - name: 上传 M3U8 地址作为工件
        uses: actions/upload-artifact@v4
        with:
          name: live-stream-url
          path: live_stream_url.txt

      - name: （可选）将地址提交到仓库
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add live_stream_url.txt
          git diff --quiet && git diff --staged --quiet || git commit -m "更新直播流地址 [skip ci]"
          git push
